<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>网页版坦克大战 - 修复版</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #222; }
    canvas {
      display: block;
      margin: 0 auto;
      background: #000;
      border: 2px solid #fff;
    }

  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="600"></canvas>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // 玩家坦克
    const player = {
      x: 400,
      y: 300,
      size: 30,
      speed: 3,
      angle: 0,
      bullets: [],
      type: 'player',
      hitPoints: 3
    };

    // 敌人坦克数组
    const enemies = [];

    // 总部（老巢）
    const base = {
      x: 375,
      y: 550,
      width: 50,
      height: 30,
      destroyed: false
    };

    // 键盘状态
    const keys = {
      ArrowUp: false,
      ArrowDown: false,
      ArrowLeft: false,
      ArrowRight: false
    };

    // 键盘监听
    document.addEventListener('keydown', e => {
      if (e.key in keys) keys[e.key] = true;
      if (e.key === ' ') shootBullet(player);
    });

    document.addEventListener('keyup', e => {
      if (e.key in keys) keys[e.key] = false;
    });

    // 发射子弹
    function shootBullet(tank) {
      const rad = (tank.angle * Math.PI) / 180;
      // 修正子弹生成位置与炮口方向对齐
      const offsetX = Math.sin(rad) * (tank.size / 2); // 调整为与炮口三角形一致
      const offsetY = -Math.cos(rad) * (tank.size / 2); // 注意负号

      tank.bullets.push({
        x: tank.x + offsetX,
        y: tank.y + offsetY,
        angle: tank.angle,
        speed: 7
      });
    }

    // 更新玩家坦克
    function updatePlayer() {
      let newX = player.x;
      let newY = player.y;

      if (keys.ArrowUp) {
        player.angle = 0;
        newY -= player.speed;
      }
      if (keys.ArrowRight) {
        player.angle = 90;
        newX += player.speed;
      }
      if (keys.ArrowDown) {
        player.angle = 180;
        newY += player.speed;
      }
      if (keys.ArrowLeft) {
        player.angle = 270;
        newX -= player.speed;
      }

      // 防止出界
      player.x = Math.max(15, Math.min(canvas.width - 15, newX));
      player.y = Math.max(15, Math.min(canvas.height - 15, newY));
    }

    // 创建敌人坦克
    function spawnEnemy() {
      const types = [
        { name: 'normal', hitPoints: 1, color: 'red' },
        { name: 'fast', hitPoints: 1, color: 'orange' },
        { name: 'armor', hitPoints: 3, color: 'purple' }
      ];
      const type = types[Math.floor(Math.random() * types.length)];

      enemies.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: 30,
        angle: [0, 90, 180, 270][Math.floor(Math.random() * 4)],
        speed: type.name === 'fast' ? 2.5 : 1.5,
        bullets: [],
        type: type.name,
        hitPoints: type.hitPoints,
        color: type.color
      });
    }

    // 更新敌人坦克
    function updateEnemies() {
      enemies.forEach(enemy => {
        // 随机改变方向
        if (Math.random() < 0.01) {
          enemy.angle = [0, 90, 180, 270][Math.floor(Math.random() * 4)];
        }

        // 移动
        const rad = (enemy.angle * Math.PI) / 180;
        const dx = Math.cos(rad) * enemy.speed;
        const dy = Math.sin(rad) * enemy.speed;
        enemy.x += dx;
        enemy.y += dy;

        // 边界限制
        enemy.x = Math.max(15, Math.min(canvas.width - 15, enemy.x));
        enemy.y = Math.max(15, Math.min(canvas.height - 15, enemy.y));

        // 自动射击
        if (Math.random() < 0.02) {
          shootBullet(enemy);
        }
      });
    }

    // 绘制坦克（调整炮口坐标系）
    function drawTank(tank) {
      ctx.save();
      ctx.translate(tank.x, tank.y);
      ctx.rotate((tank.angle * Math.PI) / 180);

      // 坦克车身
      ctx.fillStyle = tank.color || 'lime';
      ctx.fillRect(-tank.size / 2, -tank.size / 2, tank.size, tank.size);

      // 炮口（调整坐标系）
      ctx.beginPath();
      ctx.moveTo(0, -tank.size/2 + 5);  // 炮管延伸长度
      ctx.lineTo(-5, -tank.size/2);     // 宽度调整
      ctx.lineTo(5, -tank.size/2);
      ctx.closePath();
      ctx.fillStyle = 'yellow';
      ctx.fill();

      ctx.restore();
    }

    // 绘制总部
    function drawBase() {
      if (!base.destroyed) {
        ctx.fillStyle = 'blue';
        ctx.fillRect(base.x, base.y, base.width, base.height);
      } else {
        ctx.fillStyle = 'gray';
        ctx.fillRect(base.x, base.y, base.width, base.height);
      }
    }

    // 绘制子弹
    function drawBullets() {
      ctx.fillStyle = 'red';
      [...player.bullets, ...enemies.flatMap(e => e.bullets)].forEach(b => {
        ctx.fillRect(b.x - 2, b.y - 2, 4, 4);
      });
    }

    // 更新所有子弹
    function updateBullets() {
      // 玩家子弹
      for (let i = player.bullets.length - 1; i >= 0; i--) {
        const b = player.bullets[i];
        const rad = (b.angle * Math.PI) / 180;
        b.x += Math.cos(rad) * b.speed;
        b.y += Math.sin(rad) * b.speed;

        if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
          player.bullets.splice(i, 1);
          continue;
        }

        // 击中敌人
        for (let j = enemies.length - 1; j >= 0; j--) {
          const e = enemies[j];
          const dx = b.x - e.x;
          const dy = b.y - e.y;
          if (Math.sqrt(dx * dx + dy * dy) < e.size) {
            e.hitPoints--;
            player.bullets.splice(i, 1);
            if (e.hitPoints <= 0) {
              enemies.splice(j, 1);
            }
            break;
          }
        }
      }

      // 敌人子弹
      for (const enemy of enemies) {
        for (let i = enemy.bullets.length - 1; i >= 0; i--) {
          const b = enemy.bullets[i];
          const rad = (b.angle * Math.PI) / 180;
          b.x += Math.cos(rad) * b.speed;
          b.y += Math.sin(rad) * b.speed;

          if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
            enemy.bullets.splice(i, 1);
            continue;
          }

          // 击中玩家
          const dx = b.x - player.x;
          const dy = b.y - player.y;
          if (Math.sqrt(dx * dx + dy * dy) < player.size) {
            player.hitPoints--;
            enemy.bullets.splice(i, 1);
            if (player.hitPoints <= 0) {
              alert("游戏结束：你被击败了！");
              location.reload();
            }
          }

          // 击中总部
          if (!base.destroyed &&
              b.x >= base.x && b.x <= base.x + base.width &&
              b.y >= base.y && b.y <= base.y + base.height) {
            base.destroyed = true;
            enemy.bullets.splice(i, 1);
            alert("游戏失败：总部被摧毁！");
            location.reload();
          }
        }
      }
    }

    // 游戏主循环
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      updatePlayer();
      updateEnemies();
      updateBullets();

      drawTank(player);
      enemies.forEach(drawTank);
      drawBase();
      drawBullets();

      requestAnimationFrame(gameLoop);
    }

    // 每隔一段时间生成敌人
    setInterval(spawnEnemy, 3000);

    gameLoop();
  </script>
</body>
</html>
